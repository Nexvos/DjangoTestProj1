{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load staticfiles %}
{% load mathfilters %}


{% block head_title %}Betting | {{ block.super }}{% endblock %}


<style>
{% block style %}
.navbar-static-top {
	margin-bottom: 0px !important;
}
.jumbotron {
	background-color:#f6f6f6;
	color: #000000;
}
{% endblock %}
</style>


{% block extracss %}
    {% load static %}

    <link rel="stylesheet" type="text/css" href="{% static 'userbetting/style.css' %}" />
    <meta charset="UTF-8">
{% endblock %}

{% block jumbotron %}
<div class="jumbotron">
    <div class="container">
    <div class="row">
    <div class="col-md-8 col-md-offset-1">
        <div class="widget">
            <div id="chart" class="chart-container"></div>
        </div>
    </div>

</div>
</div>
</div>
<button id="update">Update</button>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>

<script>
{#pie chart stuff#}
var color = d3.scale.ordinal()
    .range(["#222222", "#404B69", "#FF7100", "#BE3030", "#F3ECC8"]);

var dataset = [
        {% for bet in game.bet_set.all %}
            {
            name:'{{ bet.user }}',
            amount:{{ bet.amount }},
            percent: {{ bet.amount|div:total_bet|mul:100 }},
            team:'{{ bet.chosen_team }}'
            },
        {% endfor %}
];

var totalamount = {{ total_bet }};
</script>

<script src="{% static 'userbetting/pie.js' %}"></script>

<script>

{# Websocket stuff#}
var gameId = {{ game.game_id }};

function onOpen (evt) {
    console.log("connected to websocket!");
};
function onMessage (evt) {
    var data = JSON.parse(evt.data);

    console.log(data['message']);
    var message = data['message'];
    var total_bet = Number(data['total_bet']);
    console.log(typeof (total_bet));
    console.log(total_bet);

    change(JSON.parse(message));
};
function onClose (evt) {
    console.log("Closed websocket!");
};

var dataSocket = new WebSocket(
'ws://' + window.location.host +
'/ws/betting/' + gameId + '/');



$("#update").click(function (e) {
    dataSocket.send(JSON.stringify({
        message: 'test'
    })
    );
    console.log("test");
});
dataSocket.onopen = function (evt) { onOpen(evt) };
dataSocket.onmessage = function (evt) { onMessage(evt) };
dataSocket.onclose = function (evt) { onClose(evt) };

</script>




{% endblock %}

{% block content %}

    <h1>{{ game.team_a }} vs {{ game.team_b }} <small>{{ game.game_date|date:"d-F Y H:i" }}</small></h1>

    {{ total_bet }}

<ul>
{% for bet in game.bet_set.all %}
    <li>{{ bet.user }} -- {{ bet.chosen_team }} for Â£{{ bet.amount }}</li>
{% endfor %}
</ul>

{% for bet in game.bet_set.all %}{ name:'{{ bet.user }}', amount:{{ bet.amount }}, percent: {{ bet.amount|div:total_bet|mul:100 }}, team:'{{ bet.chosen_team }}' },
{% endfor %}

{% endblock %}